/*! html5-android-pattern-lockScreen 14-11-2013 */
function Dot(a,b){var c=this;this._id=a,this._x=b.x,this._y=b.y,this._dotInnerLayer=b.innerLayer,this._listenerLayer=b.listenerLayer,this._pattern=b.pattern,this._innerCircleRadius=5,this._innerCircleFill="rgba(255,255,255,0)",this._innerCircleStroke="#aaa",this._strokeWidth=4;var d=this._dotInnerLayer.getStage(),e=Math.min(d.getWidth(),d.getHeight());this._outerCircleConfig={radius:e/10,fill:"rgba(255,255,255,0)",stroke:"lime",strokeWidth:c.strokeWidth},this._innerCircle=new Kinetic.Circle({x:c._x,y:c._y,radius:c._innerCircleRadius,fill:c._innerCircleFill,stroke:c._innerCircleStroke,strokeWidth:c.strokeWidth}),this._listenerCircle=new Kinetic.Circle({x:c._x,y:c._y,radius:c._outerCircleConfig.radius,fill:"transparent",listening:!0}),this._listenerCircle.on("mousedown mousemove touchmove",this._showUserDot.bind(this)),this._listenerCircle.on("mouseout",this._mouseout.bind(this)),this._listenerCircle.on("mouseup touchend",this._isValid.bind(this)),this._dotInnerLayer.add(this._innerCircle),this._listenerLayer.add(this._listenerCircle),this._dotInnerLayer.draw(),this._listenerLayer.draw()}function Pattern(a){this._userDots=[],this._savedPattern=[];var b=a.patternLayer.getStage(),c=b.getMousePosition()||{x:b.getWidth()/2,y:b.getHeight()/2};this._x0=c.x,this._y0=c.y,this._x=this._x0,this._y=this._y0,this._patternLayer=a.patternLayer,this._lineLayer=a.lineLayer,this._hintLayer=a.hintLayer,this._isRecording=!1,this._toBeClearedOnNextUse=!1}function PatternLockScreen(a){if(void 0===window.Kinetic)throw"[PatternLockScreen] Kinetic.js was not detected!";if(this._config={},this._config.width=a.width||400,this._config.height=a.height||400,this._config.container=a.container||null,this._config.onSuccess=a.onSuccess||null,this._config.onFailure=a.onFailure||null,this._config.pattern=a.pattern||null,null===this._config.container)throw"[PatternLockScreen] You need to specify a container!";this._stage=new Kinetic.Stage({container:this._config.container,width:this._config.width,height:this._config.height}),this._dotsInnerLayer=new Kinetic.Layer,this._dotsOuterLayer=new Kinetic.Layer,this._lineLayer=new Kinetic.Layer,this._listenerLayer=new Kinetic.Layer,this._hintLayer=new Kinetic.Layer,this._hintLayer.setOpacity(.1),this._stage.add(this._dotsInnerLayer),this._stage.add(this._dotsOuterLayer),this._stage.add(this._lineLayer),this._stage.add(this._hintLayer),this._stage.add(this._listenerLayer),this._pattern=new Pattern({patternLayer:this._dotsOuterLayer,lineLayer:this._lineLayer,hintLayer:this._hintLayer}),this._dots=[],this._draw(),null!==this._config.pattern&&this._parseAndSaveUserPattern(this._config.pattern)}Dot.prototype.getX=function(){return this._x},Dot.prototype.getY=function(){return this._y},Dot.prototype._isValid=function(){if(!this._pattern.isRecording){var a=function(){var a;return document.createEvent?(a=document.createEvent("HTMLEvents"),a.initEvent("click",!0,!0)):(a=document.createEventObject(),a.eventType="click"),a}(),b=document.getElementById("unlock-button");b.dispatchEvent?b.dispatchEvent(a):b.fireEvent&&b.fireEvent("on"+a.eventTye,a)}},Dot.prototype._showUserDot=function(){document.body.style.cursor="pointer",this._innerCircle.setStrokeWidth(2),this._dotInnerLayer.draw();var a=this,b=new Kinetic.Circle({x:a._innerCircle.getX(),y:a._innerCircle.getY(),radius:0,fill:a._outerCircleConfig.fill,stroke:a._outerCircleConfig.stroke,strokeWidth:a._outerCircleConfig.strokeWidth});this._pattern.addDot(b,this._outerCircleConfig)},Dot.prototype._mouseover=function(){document.body.style.cursor="pointer"},Dot.prototype._mouseout=function(){document.body.style.cursor="default"},Dot.prototype.clear=function(){this._innerCircle.setFill(this._innerCircleFill),this._innerCircle.setRadius(this._innerCircleRadius),this._dotInnerLayer.draw()},Pattern.prototype.setRecording=function(a){this._isRecording=a},Pattern.prototype.setToBeClearedOnNextUse=function(a){this._toBeClearedOnNextUse=a},Pattern.prototype.showHint=function(){this._hintLayer.show(),this._hintLayer.draw()},Pattern.prototype.hideHint=function(){this._hintLayer.hide(),this._hintLayer.draw()},Pattern.prototype.buildHint=function(){this._lineLayer.removeChildren();var a=this._newLine(this._savedPattern);this._hintLayer.add(a)},Pattern.prototype.addDot=function(a,b){this._toBeClearedOnNextUse&&(this.clear(),this._toBeClearedOnNextUse=!1),this.shouldDrawDot(a)&&(this._isRecording?this.savePatternDot(a):this.shouldDrawDot(a)&&this.addUserDot(a),this._patternLayer.add(a),this.setTransition(a,b),this._patternLayer.draw())},Pattern.prototype.shouldDrawDot=function(a){for(var b=this._isRecording?this._savedPattern:this._userDots,c=0;c<b.length;c+=1){var d=b[c];if(d.getX()===a.getX()&&d.getY()===a.getY())return!1}return!0},Pattern.prototype.setTransition=function(a,b){var c=this,d=new Kinetic.Tween({node:a,radius:b.radius,duration:.1,onFinish:c.drawLine()});d.play()},Pattern.prototype.addUserDot=function(a){this._userDots.push(a)},Pattern.prototype.drawLine=function(){var a,b=this._isRecording?this._savedPattern:this._userDots,c=b.length;c>=2&&(a=this._newLine(b),this._lineLayer.removeChildren(),this._lineLayer.add(a),this._lineLayer.draw())},Pattern.prototype._newLine=function(a){return new Kinetic.Shape({drawFunc:function(){var b,c=this.getContext(),d=a[0];c.beginPath(),c.moveTo(d.getX(),d.getY());for(var e=1;e<a.length;e+=1)b=a[e],c.lineTo(b.getX(),b.getY());c.lineJoin="round",c.lineCap="round",c.strokeStyle="rgba(255,255,255,0.5)",c.lineWidth=5,c.stroke(),c.closePath()},stroke:"rgba(255,255,255,0.5)",strokeWidth:5})},Pattern.prototype.isValid=function(){if(this._savedPattern.length!==this._userDots.length)return!1;for(var a=0;a<this._savedPattern.length;a++){var b=this._savedPattern[a],c=this._userDots[a];if(b.getX()!==c.getX()||b.getY()!==c.getY())return!1}return!0},Pattern.prototype.clear=function(){return this._clearUserDots(),this._clearLayers(),this},Pattern.prototype._clearUserDots=function(){this._userDots=[]},Pattern.prototype._clearLayers=function(){for(var a,b=this,c=this._patternLayer.getChildren(),d=c.length,e=0;d>e;e+=1){var f=c[e];a=new Kinetic.Tween({node:f,duration:.1,radius:0,onFinish:function(){d-1===e&&(b._patternLayer.clear(),b._patternLayer.removeChildren(),b._patternLayer.draw())}}),a.play()}b._lineLayer.clear(),b._lineLayer.removeChildren(),b._lineLayer.draw()},Pattern.prototype.savePatternDot=function(a){this._savedPattern.push({x:a.getX(),y:a.getY(),getX:function(){return this.x},getY:function(){return this.y}})},Pattern.prototype.clearSavedPattern=function(){this._savedPattern=[],this._hintLayer.removeChildren(),this._hintLayer.clear(),this._hintLayer.draw()},PatternLockScreen.prototype._parseAndSaveUserPattern=function(a){for(var b,c=a.split(/[#\|_,; -]+/),d=0;d<c.length;d+=1)if(b=+c[d]-1,b>=0&&this._dots[b]){var e=this._dots[b];this._pattern.shouldDrawDot(e)&&this._pattern.savePatternDot(e)}this._pattern.buildHint()},PatternLockScreen.prototype._draw=function(){var a,b=this._stage.getWidth(),c=this._stage.getHeight(),d=Math.floor(b/2),e=Math.floor(c/2),f=Math.floor(b/3),g=Math.floor(c/3),h=[{x:d-f,y:e-g},{x:d,y:e-g},{x:d+f,y:e-g},{x:d-f,y:e},{x:d,y:e},{x:d+f,y:e},{x:d-f,y:e+g},{x:d,y:e+g},{x:d+f,y:e+g}],i={pattern:this._pattern,innerLayer:this._dotsInnerLayer,listenerLayer:this._listenerLayer};for(a=0;a<h.length;a+=1)i.x=h[a].x,i.y=h[a].y,this._dots.push(new Dot(a,i));return this},PatternLockScreen.prototype._convertToNum=function(a){if(a.length){var b,c=this._stage.getWidth(),d=this._stage.getHeight(),e=Math.floor(c/2),f=Math.floor(d/2),g=Math.floor(c/3),h=Math.floor(d/3),i=[[e-g,f-h].join("|"),[e,f-h].join("|"),[e+g,f-h].join("|"),[e-g,f].join("|"),[e,f].join("|"),[e+g,f].join("|"),[e-g,f+h].join("|"),[e,f+h].join("|"),[e+g,f+h].join("|")],j=[];for(b=0;b<a.length;b+=1){var k=[a[b].x,a[b].y].join("|");i.indexOf(k)>-1&&j.push(i.indexOf(k)+1)}return j}},PatternLockScreen.prototype.clear=function(){this._pattern.clear();for(var a=0;a<this._dots.length;a+=1)this._dots[a].clear()},PatternLockScreen.prototype.reset=function(){this.clear(),this._pattern.clearSavedPattern()},PatternLockScreen.prototype.unlock=function(){return this._pattern.isValid()?(this.validatePattern(),this._config.onSuccess&&this._config.onSuccess.call(this),!0):(this.invalidatePattern(),this._config.onFailure&&this._config.onFailure.call(this),!1)},PatternLockScreen.prototype.validatePattern=function(){},PatternLockScreen.prototype.invalidatePattern=function(){var a=this._dotsOuterLayer.getChildren(),b=this._lineLayer.getChildren();if(b.length>0){b[0].setFill("rgba(255,0,0,0.5)");for(var c=0;c<a.length;c+=1){{var d=a[c];d.getRadius()}d.setStroke("rgba(255,0,0,0.8)")}this._dotsOuterLayer.draw(),this._lineLayer.draw(),this._pattern.setToBeClearedOnNextUse(!0)}},PatternLockScreen.prototype.startRecordPattern=function(){this.clear(),this._pattern.clearSavedPattern(),this._pattern.setRecording(!0),this._pattern.setToBeClearedOnNextUse(!1)},PatternLockScreen.prototype.stopRecordPattern=function(){this.clear(),this._pattern.setRecording(!1),this._pattern.buildHint()},PatternLockScreen.prototype.showHint=function(a){a?this._pattern.showHint():this._pattern.hideHint()},PatternLockScreen.prototype.resultHint=function(){return this._convertToNum(this._pattern._savedPattern)},PatternLockScreen.prototype.setInitPattern=function(a){this.reset(),this._parseAndSaveUserPattern(a)},function(){window.addEventListener("load",function(){var a=new PatternLockScreen({container:"lock-screen",width:400,height:400,onSuccess:function(){console.log("success")},onFailure:function(){console.log("failure")},pattern:"8-5-2"}),b=document.getElementById("unlock-button"),c=document.getElementById("save-pattern-button"),d=document.getElementById("reset-button"),e=!0;c.addEventListener("click",function(){var c=this.getElementsByClassName("gray");console.log(a.resultHint()),"red"===c.className?(this.innerHTML='<span class="gray"></span>Record Pattern',c.className="gray",a.stopRecordPattern(),b.style.display="inline"):(this.innerHTML='<span class="red"></span>Recording...',c.className="red",a.startRecordPattern(),b.style.display="none")},!1),b.addEventListener("click",function(){var b=this;a.unlock()?(b.className="button green",alert("Access Granted!")):(this.className="button red",setTimeout(function(){b.className="button blue"},1e3))},!1),d.addEventListener("click",function(){a.reset()}),document.getElementById("setOrg").addEventListener("click",function(){var b=document.getElementById("testLock").value;a.setInitPattern(b)},!1),document.addEventListener("keyup",function(b){var c=b.keyCode||b.which;72===c&&(a.showHint(e),e=!e)})},!1)}();